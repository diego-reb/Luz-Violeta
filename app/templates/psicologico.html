<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apoyo Psicol√≥gico - Luz Violeta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/accesibilidad.css')}}">
    <script src="{{ url_for('static', filename='JS/accesibilidad.js')}}"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f1ff;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .floating-element {
            animation: float 15s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        .floating-element-2 {
            animation: float-alt 18s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0.6; }
            25% { transform: translateY(-20px) translateX(15px) rotate(8deg); opacity: 0.8; }
            50% { transform: translateY(-40px) translateX(-15px) rotate(-8deg); opacity: 0.6; }
            75% { transform: translateY(-20px) translateX(15px) rotate(8deg); opacity: 0.8; }
        }

        @keyframes float-alt {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0.5; }
            30% { transform: translateY(15px) translateX(-20px) rotate(-10deg); opacity: 0.7; }
            60% { transform: translateY(30px) translateX(20px) rotate(10deg); opacity: 0.5; }
        }

        @keyframes fadeScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-fade {
            animation: fadeScale 0.15s ease-out;
        }

        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f3e8ff;
            border-radius: 4px;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #c084fc;
            border-radius: 4px;
        }
    </style>
</head>
<body class="high-contrast">
    <div id="reading-guide" class="reading-guide-mask"></div>

    <header class="bg-white shadow-md rounded-b-2xl px-4 py-3 flex items-center justify-between relative z-50">
        <a href="/" class="flex items-center space-x-2 shrink-0">
            <img src="https://placehold.co/60x60/a78bfa/ffffff?text=LV" alt="Logo Luz Violeta" class="rounded-xl shadow-lg w-10 h-10 md:w-14 md:h-14">
            <span class="text-xl md:text-3xl font-extrabold text-purple-700">Luz Violeta</span>
        </a>

        <!-- Navegaci√≥n desktop -->
        <nav class="hidden lg:flex space-x-2 items-center">
            <a href="/Quienes_somos" class="bg-purple-100 hover:bg-purple-200 text-purple-800 font-semibold py-2 px-4 rounded-full transition-all duration-300 shadow-md text-sm transform hover:scale-105">
                Qui√©nes somos
            </a>
            <a href="/albergues" class="bg-purple-100 hover:bg-purple-200 text-purple-800 font-semibold py-2 px-4 rounded-full transition-all duration-300 shadow-md text-sm transform hover:scale-105">
                Albergues
            </a>
            <a href="/apoyo_legal" class="bg-purple-100 hover:bg-purple-200 text-purple-800 font-semibold py-2 px-4 rounded-full transition-all duration-300 shadow-md text-sm transform hover:scale-105">
                Apoyo legal
            </a>
            <a href="/apoyo_psicologico" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-full transition-all duration-300 shadow-md text-sm transform hover:scale-105">
                Apoyo psicol√≥gico
            </a>
            
            <!-- Bot√≥n de cuenta para desktop -->
            <div class="relative">
                <button id="userMenuBtnDesktop" class="flex items-center bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-full transition duration-300 shadow-md cursor-pointer">
                    <span>Cuenta</span>
                    <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="userMenuDesktop" class="hidden absolute right-0 mt-2 w-48 bg-white shadow-xl rounded-xl py-2 border border-purple-200 animate-fade z-50">
                    {% if session.get('usuario_id') %}
                        <a href="/perfil" class="block px-4 py-2 text-gray-700 hover:bg-purple-100 transition">Perfil</a>
                        <div class="border-t border-gray-200 my-2"></div>
                        <a href="{{ url_for('login_bp.logout') }}" class="block px-4 py-2 text-red-600 hover:bg-red-100 transition">Cerrar sesi√≥n</a>
                    {% else %}
                        <a href="{{ url_for('login_bp.login') }}" class="block px-4 py-2 text-gray-700 hover:bg-purple-100 transition">Iniciar sesi√≥n</a>
                    {% endif %}
                </div>
            </div>
        </nav>

        <!-- Bot√≥n de hamburguesa para m√≥vil -->
        <button id="hamburgerBtn" class="lg:hidden flex items-center justify-center p-2 rounded-md bg-purple-600 text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-400 cursor-pointer shadow-md">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
    </header>

    <!-- Men√∫ hamburguesa para m√≥vil -->
    <div id="mobileMenu" class="hidden lg:hidden fixed inset-x-4 top-20 bg-white shadow-2xl rounded-xl py-4 border border-purple-200 animate-fade z-50 max-h-[80vh] overflow-y-auto">
        <div class="px-4 space-y-2 mb-4">
            <h3 class="text-purple-700 font-bold text-lg mb-2 px-2">Navegaci√≥n</h3>
            <a href="/Quienes_somos" class="flex items-center px-4 py-3 text-purple-800 hover:bg-purple-50 rounded-lg">
                <span class="mr-3">üë•</span>
                <span>Qui√©nes somos</span>
            </a>
            <a href="/albergues" class="flex items-center px-4 py-3 text-purple-800 hover:bg-purple-50 rounded-lg">
                <span class="mr-3">üè†</span>
                <span>Albergues</span>
            </a>
            <a href="/apoyo_legal" class="flex items-center px-4 py-3 text-purple-800 hover:bg-purple-50 rounded-lg">
                <span class="mr-3">‚öñÔ∏è</span>
                <span>Apoyo legal</span>
            </a>
            <a href="/apoyo_psicologico" class="flex items-center px-4 py-3 font-bold text-purple-700 bg-purple-50 rounded-lg">
                <span class="mr-3">üíú</span>
                <span>Apoyo psicol√≥gico</span>
            </a>
        </div>
        
        <div class="border-t border-gray-200 pt-4 px-4">
            <h3 class="text-purple-700 font-bold text-lg mb-2 px-2">Mi cuenta</h3>
            {% if session.get('usuario_id') %}
                <a href="/perfil" class="flex items-center px-4 py-3 text-gray-700 hover:bg-purple-100 rounded-lg">
                    <span class="mr-3">üë§</span>
                    <span>Mi Perfil</span>
                </a>
                <div class="border-t border-gray-200 my-2"></div>
                <a href="{{ url_for('login_bp.logout') }}" class="flex items-center px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg">
                    <span class="mr-3">üö™</span>
                    <span>Cerrar sesi√≥n</span>
                </a>
            {% else %}
                <a href="{{ url_for('login_bp.login') }}" class="flex items-center px-4 py-3 text-purple-700 font-bold hover:bg-purple-50 rounded-lg">
                    <span class="mr-3">üîê</span>
                    <span>Iniciar sesi√≥n</span>
                </a>
            {% endif %}
        </div>
    </div>

    <main class="container mx-auto p-4 md:p-8 flex-grow relative z-10 flex flex-col justify-center">
        <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl mt-4 relative card-hover transition-all duration-300 w-full max-w-4xl mx-auto border border-purple-100">
            
            <div class="text-center mb-6">
                <span class="text-4xl">‚ú®</span>
                <h2 class="text-2xl md:text-3xl font-bold text-purple-800 mt-2">Asistente de Apoyo Virtual</h2>
                <p class="text-gray-500 text-sm md:text-base mt-1">Un espacio seguro para expresarte sin juicios.</p>
            </div>

            <div id="chat-container" class="h-[50vh] min-h-[300px] max-h-[600px] overflow-y-auto mb-4 p-4 border border-purple-200 rounded-xl bg-gray-50 flex flex-col space-y-4 shadow-inner">
                <div class="p-4 rounded-2xl rounded-tl-none bg-purple-100 self-start max-w-[85%] shadow-sm">
                    <p class="text-gray-800 text-sm md:text-base break-words">¬°Hola! Estoy aqu√≠ para escucharte y ofrecerte una palabra de aliento. Recuerda que no est√°s sola. ¬øC√≥mo te sientes hoy?</p>
                </div>
            </div>

            <div class="flex flex-row gap-2 items-center">
                <input type="text" id="chat-input" placeholder="Escribe tu mensaje aqu√≠..." class="flex-1 p-3 md:p-4 border border-purple-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white shadow-sm text-sm md:text-base transition-shadow min-w-0">
                <button id="send-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 md:px-6 rounded-xl transition duration-300 shadow-md hover:shadow-lg flex items-center justify-center gap-2 shrink-0">
                    <span class="hidden sm:inline">Enviar</span> 
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                    </svg>
                </button>
            </div>

            <div id="loading-indicator" class="mt-3 text-purple-600 text-center text-sm font-semibold hidden flex justify-center items-center gap-2">
                <svg class="animate-spin h-5 w-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Escribiendo una respuesta con cari√±o...
            </div>
        </div>
    </main>

    <footer class="bg-purple-900 text-white text-center py-6 mt-8 shadow-inner rounded-t-2xl z-20">
        <p class="font-medium">¬© 2025 Luz Violeta. Juntas somos invencibles.</p>
        <p class="text-xs text-purple-200 mt-1">Todos los derechos reservados.</p>
    </footer>

    <!-- Elementos decorativos flotantes -->
    <span class="floating-element absolute top-[10%] left-[5%] md:left-[20%] text-purple-300 text-5xl md:text-7xl">‚ú®</span>
    <span class="floating-element-2 absolute top-[60%] right-[5%] md:left-[70%] text-pink-300 text-4xl md:text-6xl" style="animation-delay: 2s;">üíñ</span>
    <span class="floating-element absolute top-[80%] left-[10%] md:left-[30%] text-purple-400 text-4xl md:text-5xl" style="animation-delay: 4s;">‚ú®</span>
    <span class="floating-element-2 absolute top-[40%] left-[5%] text-pink-400 text-6xl md:text-8xl" style="animation-delay: 6s;">üå∏</span>
    <span class="floating-element absolute top-[25%] right-[10%] md:left-[85%] text-purple-300 text-4xl md:text-5xl" style="animation-delay: 3s;">ü¶ã</span>
    <span class="floating-element absolute top-[50%] left-[50%] text-purple-400 text-5xl md:text-6xl transform -translate-x-1/2" style="animation-delay: 7s;">üíñ</span>

    <script>
        // Men√∫ de usuario para DESKTOP
        const userMenuBtnDesktop = document.getElementById('userMenuBtnDesktop');
        const userMenuDesktop = document.getElementById('userMenuDesktop');
        
        // Men√∫ hamburguesa para M√ìVIL
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const mobileMenu = document.getElementById('mobileMenu');

        // Elementos del chat
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatContainer = document.getElementById('chat-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        // ========== CONTROL DE MEN√öS ==========

        // Men√∫ de usuario (DESKTOP)
        if(userMenuBtnDesktop && userMenuDesktop) {
            userMenuBtnDesktop.addEventListener('click', (e) => {
                e.stopPropagation();
                userMenuDesktop.classList.toggle('hidden');
                // Cierra el men√∫ m√≥vil si est√° abierto
                if(mobileMenu && !mobileMenu.classList.contains('hidden')) {
                    mobileMenu.classList.add('hidden');
                }
            });
        }

        // Men√∫ hamburguesa (M√ìVIL)
        if(hamburgerBtn && mobileMenu) {
            hamburgerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenu.classList.toggle('hidden');
                // Cierra el men√∫ desktop si est√° abierto
                if(userMenuDesktop && !userMenuDesktop.classList.contains('hidden')) {
                    userMenuDesktop.classList.add('hidden');
                }
            });
        }

        // Cerrar men√∫s al hacer clic fuera
        document.addEventListener('click', (e) => {
            // Cerrar men√∫ desktop
            if(userMenuDesktop && !userMenuDesktop.classList.contains('hidden') && 
               !userMenuBtnDesktop.contains(e.target) && !userMenuDesktop.contains(e.target)) {
                userMenuDesktop.classList.add('hidden');
            }
            
            // Cerrar men√∫ m√≥vil
            if(mobileMenu && !mobileMenu.classList.contains('hidden') && 
               !hamburgerBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                mobileMenu.classList.add('hidden');
            }
        });

        // Cerrar men√∫s al presionar ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if(userMenuDesktop && !userMenuDesktop.classList.contains('hidden')) {
                    userMenuDesktop.classList.add('hidden');
                }
                if(mobileMenu && !mobileMenu.classList.contains('hidden')) {
                    mobileMenu.classList.add('hidden');
                }
            }
        });

        // ========== L√ìGICA DEL CHAT ==========
        const chatHistory = [{
            role: "user",
            parts: [{
                text: "Act√∫a como un bot de apoyo compasivo y emp√°tico para mujeres que buscan ayuda por violencia o angustia emocional..."
            }]
        }];

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            appendMessage(userMessage, 'user');
            chatInput.value = '';
            loadingIndicator.classList.remove('hidden');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50', 'cursor-not-allowed');

            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMessage, history: chatHistory })
                });

                const data = await response.json();

                if (data.reply) {
                    appendMessage(data.reply, 'bot');
                    chatHistory.push({ role: "model", parts: [{ text: data.reply }] });
                } else {
                    appendMessage("Lo siento, tuve un peque√±o problema al pensar mi respuesta. ¬øPodr√≠as intentar de nuevo?", 'bot');
                }

            } catch (error) {
                appendMessage(`Lo siento, ocurri√≥ un error de conexi√≥n. Por favor verifica tu internet.`, 'bot');
                console.error(error);
            } finally {
                loadingIndicator.classList.add('hidden');
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                chatInput.focus();
                setTimeout(() => {
                    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
                }, 100);
            }
        }

        function appendMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('p-3', 'md:p-4', 'rounded-2xl', 'shadow-sm', 'max-w-[85%]', 'animate-fade', 'text-sm', 'md:text-base');

            if (sender === 'user') {
                messageElement.classList.add('bg-purple-200', 'self-end', 'text-right', 'rounded-tr-none');
            } else {
                messageElement.classList.add('bg-purple-100', 'self-start', 'rounded-tl-none');
            }

            const p = document.createElement('p');
            p.classList.add('text-gray-800', 'break-words');
            p.textContent = text; 
            messageElement.appendChild(p);

            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>